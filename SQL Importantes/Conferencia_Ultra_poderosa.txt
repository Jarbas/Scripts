SELECT LFE.COD_EMPRESA, LFE.COD_ENTRADA, LFE.NUMERO_NF, LFE.DATA_ENTRADA, LFE.COD_TIPO_MOVIMENTO, LFEI.COD_PRODUTO, PR.DESCRICAO, LFEI.COD_CFOP, CF.DESCRICAO, 


LFEI.QUANTIDADE AS QTDA_NOTA,

(SELECT PM.QUANTIDADE FROM PRODUTOS_MOVIMENTO PM 
WHERE PM.COD_EMPRESA = LFEI.COD_EMPRESA AND  PM.COD_PRODUTO = LFEI.COD_PRODUTO  AND PM.COD_MOVIMENTO = LFEI.COD_MOVIMENTO AND PM.SITUACAO = 'A'  )AS QTDA_ESTOQUE,

(SELECT SUM(LFEII.VALOR_IMPOSTO) FROM LCTO_FISCAL_ENT_ITENS_IMP LFEII 
WHERE LFEII.COD_EMPRESA = LFE.COD_EMPRESA AND  LFEII.COD_ENTRADA = LFE.COD_ENTRADA AND LFEII.SEQUENCIA = LFEI.SEQUENCIA  AND LFEII.TIPO_IMPOSTO IN(1)  ) AS ICMS,

(SELECT SUM(LFEII.VALOR_IMPOSTO) FROM LCTO_FISCAL_ENT_ITENS_IMP LFEII 
WHERE LFEII.COD_EMPRESA = LFE.COD_EMPRESA AND LFEII.COD_ENTRADA = LFE.COD_ENTRADA AND LFEII.SEQUENCIA = LFEI.SEQUENCIA AND LFEII.TIPO_IMPOSTO IN(2)  ) AS IPI,

(SELECT SUM(LFEII.VALOR_IMPOSTO) FROM LCTO_FISCAL_ENT_ITENS_IMP LFEII 
WHERE LFEII.COD_EMPRESA = LFE.COD_EMPRESA AND LFEII.COD_ENTRADA = LFE.COD_ENTRADA AND LFEII.SEQUENCIA = LFEI.SEQUENCIA AND LFEII.TIPO_IMPOSTO IN(3)  ) AS PIS,

(SELECT SUM(LFEII.VALOR_IMPOSTO) FROM LCTO_FISCAL_ENT_ITENS_IMP LFEII 
WHERE LFEII.COD_EMPRESA = LFE.COD_EMPRESA AND LFEII.COD_ENTRADA = LFE.COD_ENTRADA AND LFEII.SEQUENCIA = LFEI.SEQUENCIA AND LFEII.TIPO_IMPOSTO IN(4)  ) AS COFINS,

LFEI.VALOR_UNITARIO AS VL_UNITARIO_NOTA,

(SELECT SUM(PM.VALOR_UNITARIO ) FROM PRODUTOS_MOVIMENTO PM 
WHERE PM.COD_EMPRESA = LFE.COD_EMPRESA AND PM.COD_DOCUMENTO = LFE.COD_ENTRADA AND PM.COD_PRODUTO = LFEI.COD_PRODUTO AND PM.COD_MOVIMENTO = LFEI.COD_MOVIMENTO AND PM.SITUACAO = 'A' ) AS VL_UNITARIO,

(SELECT SUM(PM.VALOR_DIF_ALIQUOTA ) FROM PRODUTOS_MOVIMENTO PM 
WHERE PM.COD_EMPRESA = LFE.COD_EMPRESA AND PM.COD_DOCUMENTO = LFE.COD_ENTRADA AND PM.COD_PRODUTO = LFEI.COD_PRODUTO AND PM.COD_MOVIMENTO = LFEI.COD_MOVIMENTO AND PM.SITUACAO = 'A' ) AS VL_DIF_ALICOTA,

(SELECT SUM(PM.VALOR_DIF_ALIQUOTA_FRETE ) FROM PRODUTOS_MOVIMENTO PM 
WHERE PM.COD_EMPRESA = LFE.COD_EMPRESA AND PM.COD_DOCUMENTO = LFE.COD_ENTRADA AND PM.COD_PRODUTO = LFEI.COD_PRODUTO AND PM.COD_MOVIMENTO = LFEI.COD_MOVIMENTO AND PM.SITUACAO = 'A' ) AS VL_DIF_ALICOTA_FRETE,

(SELECT SUM(PM.VALOR_RATEIO_FRETE ) FROM PRODUTOS_MOVIMENTO PM 
WHERE PM.COD_EMPRESA = LFE.COD_EMPRESA AND PM.COD_DOCUMENTO = LFE.COD_ENTRADA AND PM.COD_PRODUTO = LFEI.COD_PRODUTO AND PM.COD_MOVIMENTO = LFEI.COD_MOVIMENTO AND PM.SITUACAO = 'A' ) AS VL_RATEIO_FRETE,

( SELECT MAX(COD_CONHECIMENTO)
FROM CONHECIMENTO_FRETE_NOTAS_ENT CFNE WHERE CFNE.COD_EMPRESA = LFE.COD_EMPRESA AND CFNE.COD_ENTRADA = LFE.COD_ENTRADA  ) AS CONHECIMENTO ,


(SELECT SUM(PM.VALOR_RATEIO_SERV ) FROM PRODUTOS_MOVIMENTO PM 
WHERE PM.COD_EMPRESA = LFE.COD_EMPRESA AND PM.COD_DOCUMENTO = LFE.COD_ENTRADA AND PM.COD_PRODUTO = LFEI.COD_PRODUTO AND PM.COD_MOVIMENTO = LFEI.COD_MOVIMENTO AND PM.SITUACAO = 'A' ) AS VL_RATEIO_SERV
 
 FROM LCTO_FISCAL_ENT_ITENS LFEI
 
LEFT JOIN LCTO_FISCAL_ENT LFE ON LFEI.COD_ENTRADA = LFE.COD_ENTRADA AND LFEI.COD_EMPRESA  = LFE.COD_EMPRESA
LEFT JOIN PRODUTOS PR ON LFEI.COD_PRODUTO = PR.COD_PRODUTO
LEFT JOIN CFOP CF ON LFEI.COD_CFOP = CF.COD_CFOP AND LFEI.COD_EMPRESA = CF.COD_EMPRESA


WHERE TRUNC(LFE.DATA_ENTRADA) BETWEEN TO_DATE('01/11/2014') AND TO_DATE('30/11/2014')   AND ( (LFE.ID_CANCELADA <> 'S') OR (LFE.ID_CANCELADA <> 'E' )) ;